name: Database Checks - RLS, Index, and Query Performance

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_full_checks:
        description: 'Run full database checks'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  database-checks:
    name: Database Health Checks
    runs-on: ubuntu-latest
    
    # Only run if DATABASE_URL secret is configured
    if: vars.DATABASE_URL != '' || secrets.DATABASE_URL != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Verify Database Connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Testing database connection..."
          psql "$DATABASE_URL" -c "SELECT version();" || echo "Database connection failed"
      
      - name: Run RLS Checks
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running Row Level Security checks..."
          ./ci/scripts/check_rls_policies.sh
        continue-on-error: true
      
      - name: Run Index Health Checks
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running index health checks..."
          psql "$DATABASE_URL" -f ci/sql/index_checks.sql > ci/artifacts/index_checks_latest.txt
        continue-on-error: true
      
      - name: Run Table Statistics
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Gathering table statistics..."
          psql "$DATABASE_URL" -f ci/sql/table_stats.sql > ci/artifacts/table_stats_latest.txt
        continue-on-error: true
      
      - name: Run Query Performance Analysis
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Analyzing query performance..."
          ./ci/scripts/analyze_query_performance.sh
        continue-on-error: true
      
      - name: Run Full Database Checks
        if: github.event.inputs.run_full_checks == 'true' || github.event_name == 'schedule'
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running full database checks..."
          ./ci/scripts/run_db_checks.sh
        continue-on-error: true
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: database-check-results
          path: ci/artifacts/*.txt
          retention-days: 30
      
      - name: Check for Critical Issues
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Checking for critical database issues..."
          
          # Check cache hit ratio
          CACHE_HIT=$(psql "$DATABASE_URL" -t -c "SELECT ROUND(sum(heap_blks_hit)::numeric / NULLIF(sum(heap_blks_hit) + sum(heap_blks_read), 0) * 100, 2) FROM pg_statio_user_tables;" | xargs)
          echo "Cache Hit Ratio: ${CACHE_HIT}%"
          
          if (( $(echo "$CACHE_HIT < 95" | bc -l) )); then
            echo "::warning::Cache hit ratio is below 95% (${CACHE_HIT}%)"
          fi
          
          # Check for tables without RLS
          TABLES_WITHOUT_RLS=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM pg_tables WHERE schemaname NOT IN ('pg_catalog', 'information_schema') AND rowsecurity = false;" | xargs)
          echo "Tables without RLS: $TABLES_WITHOUT_RLS"
          
          if [ "$TABLES_WITHOUT_RLS" -gt 0 ]; then
            echo "::warning::Found $TABLES_WITHOUT_RLS tables without Row Level Security enabled"
          fi
          
          # Check for unused indexes
          UNUSED_INDEXES=$(psql "$DATABASE_URL" -t -c "SELECT COUNT(*) FROM pg_stat_user_indexes WHERE idx_scan = 0;" | xargs)
          echo "Unused Indexes: $UNUSED_INDEXES"
          
          if [ "$UNUSED_INDEXES" -gt 5 ]; then
            echo "::warning::Found $UNUSED_INDEXES unused indexes that could be removed"
          fi
        continue-on-error: true
      
      - name: Generate Summary Report
        if: always()
        run: |
          echo "## Database Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ RLS Policy Validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Index Health Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Table Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ Query Performance Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "Check the uploaded artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
      
  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: database-checks
    if: failure() && github.event_name == 'schedule'
    
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”´ Database Checks Failed - ' + new Date().toISOString().split('T')[0],
              body: `## Database Health Check Failure\n\nThe scheduled database checks have failed.\n\n**Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Time:** ${new Date().toUTCString()}\n\nPlease review the workflow logs and artifacts for details.`,
              labels: ['database', 'automated-check', 'bug']
            });
            console.log('Created issue:', issue.data.html_url);
