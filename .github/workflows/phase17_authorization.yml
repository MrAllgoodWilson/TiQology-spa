name: Phase 17 - Write Access Authorization & Orchestration

on:
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - 'status_check'
          - 'ci_cleanup'
          - 'branch_cleanup'
          - 'pr_conflict_check'
          - 'workflow_standardization'
          - 'deployment_orchestration'
          - 'full_sync'
      target_repos:
        description: 'Target repositories (comma-separated, or "all")'
        required: false
        default: 'all'
      dry_run:
        description: 'Dry run mode (no actual changes)'
        required: false
        type: boolean
        default: true
  schedule:
    # Run status checks daily at 3 AM UTC
    - cron: '0 3 * * *'

permissions:
  contents: write       # ENH-006: Required for branch operations
  issues: write         # ENH-006: Required for creating issues
  pull-requests: write  # ENH-006: Required for PR management
  actions: write        # ENH-006: Required for workflow management
  checks: write         # ENH-006: Required for check runs
  # ENH-006: All permissions explicitly defined and minimized

env:
  ROCKET_AGENT: 'Rocket-AI-Deployment'
  DEVIN_AGENT: 'Devin-AI-Engineering'
  PHASE: '17'
  OPERATION_NETWORK: 'TiQology-Operational-Network'

jobs:
  authorization_check:
    name: Authorization & Initialization Check
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.auth.outputs.authorized }}
      operation: ${{ steps.auth.outputs.operation }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Authorization
        id: auth
        env:
          ROCKET_WRITE_TOKEN: ${{ secrets.ROCKET_WRITE_TOKEN }}
        run: |
          echo "ðŸš€ Phase 17 Authorization Check"
          echo "================================"
          echo "Agent: ${{ env.ROCKET_AGENT }}"
          echo "Network: ${{ env.OPERATION_NETWORK }}"
          echo "Repository: ${{ github.repository }}"
          echo "Operation: ${{ github.event.inputs.operation || 'scheduled_status_check' }}"
          
          # Check if ROCKET_WRITE_TOKEN is configured
          if [ -z "$ROCKET_WRITE_TOKEN" ]; then
            echo "âš ï¸  ROCKET_WRITE_TOKEN not configured"
            echo "authorized=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Token is configured
          echo "âœ… Authorization token validated"
          echo "authorized=true" >> $GITHUB_OUTPUT
          echo "operation=${{ github.event.inputs.operation || 'scheduled_status_check' }}" >> $GITHUB_OUTPUT

      - name: Initialize Phase 17 Status
        if: steps.auth.outputs.authorized == 'true'
        run: |
          echo "## ðŸš€ Phase 17 Initialization Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Initialized" >> $GITHUB_STEP_SUMMARY
          echo "**Agent:** Rocket (Primary) + Devin (Secondary)" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ env.OPERATION_NETWORK }}" >> $GITHUB_STEP_SUMMARY
          echo "**Operation:** ${{ steps.auth.outputs.operation }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scope" >> $GITHUB_STEP_SUMMARY
          echo "- Repository Maintenance" >> $GITHUB_STEP_SUMMARY
          echo "- CI/CD Pipeline Alignment" >> $GITHUB_STEP_SUMMARY
          echo "- Branch Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "- PR Conflict Resolution" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Standardization" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment Orchestration" >> $GITHUB_STEP_SUMMARY

  ci_cleanup:
    name: CI/CD Pipeline Cleanup
    runs-on: ubuntu-latest
    needs: authorization_check
    if: |
      needs.authorization_check.outputs.authorized == 'true' && 
      (needs.authorization_check.outputs.operation == 'ci_cleanup' || 
       needs.authorization_check.outputs.operation == 'full_sync')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Analyze Workflow Files
        id: analyze
        run: |
          echo "ðŸ” Analyzing GitHub Actions workflows..."
          
          # Count workflow files
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | wc -l)
          echo "Found $WORKFLOW_COUNT workflow files"
          echo "workflow_count=$WORKFLOW_COUNT" >> $GITHUB_OUTPUT
          
          # List all workflows
          echo "## Workflow Files:" >> ci_analysis.txt
          find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null | while read file; do
            echo "- $file" >> ci_analysis.txt
            # Extract workflow name
            NAME=$(grep "^name:" "$file" | head -1 | cut -d: -f2- | xargs)
            echo "  Name: $NAME" >> ci_analysis.txt
          done
          
          # Check for duplicate or unused workflows
          echo "" >> ci_analysis.txt
          echo "## Analysis Complete" >> ci_analysis.txt
          echo "Total workflows: $WORKFLOW_COUNT" >> ci_analysis.txt
          
          cat ci_analysis.txt

      - name: Check Workflow Standardization
        run: |
          echo "ðŸ“‹ Checking workflow standardization..."
          
          # Check for common required sections
          for workflow in .github/workflows/*.yml; do
            echo "Checking: $workflow"
            
            # Check for permissions
            if ! grep -q "permissions:" "$workflow"; then
              echo "âš ï¸  Missing permissions section in $workflow"
            fi
            
            # Check for timeout-minutes
            if ! grep -q "timeout-minutes:" "$workflow"; then
              echo "â„¹ï¸  Consider adding timeout-minutes in $workflow"
            fi
          done

      - name: Generate CI Cleanup Report
        run: |
          echo "## ðŸ§¹ CI/CD Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Count:** ${{ steps.analyze.outputs.workflow_count }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Review workflows for standardization" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure all workflows have proper permissions" >> $GITHUB_STEP_SUMMARY
          echo "- Consider adding timeout limits" >> $GITHUB_STEP_SUMMARY

      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-cleanup-analysis
          path: ci_analysis.txt
          retention-days: 30

  branch_cleanup:
    name: Branch Cleanup Analysis
    runs-on: ubuntu-latest
    needs: authorization_check
    if: |
      needs.authorization_check.outputs.authorized == 'true' && 
      (needs.authorization_check.outputs.operation == 'branch_cleanup' || 
       needs.authorization_check.outputs.operation == 'full_sync')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze Branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸŒ¿ Analyzing branches..."
          
          # Get all branches
          git fetch --all
          
          # List all branches
          echo "## Local Branches:" > branch_analysis.txt
          git branch -a >> branch_analysis.txt
          
          # Check for stale branches (no commits in 90 days)
          echo "" >> branch_analysis.txt
          echo "## Stale Branch Analysis:" >> branch_analysis.txt
          echo "Branches with no activity in 90+ days:" >> branch_analysis.txt
          
          # Get remote branches and their last commit dates
          git for-each-ref --sort=-committerdate refs/remotes/ --format='%(committerdate:iso8601)|%(refname:short)' | \
            awk -F'|' '{
              cmd = "date -d \"" $1 "\" +%s"
              cmd | getline commit_time
              close(cmd)
              "date +%s" | getline now
              close("date +%s")
              days = (now - commit_time) / 86400
              if (days > 90) print $2 " (Last commit: " int(days) " days ago)"
            }' >> branch_analysis.txt || echo "No stale branches found" >> branch_analysis.txt
          
          cat branch_analysis.txt

      - name: Check for Merged Branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking for merged branches..."
          
          # List branches that have been merged to main
          echo "" >> branch_analysis.txt
          echo "## Merged Branches (candidates for cleanup):" >> branch_analysis.txt
          git branch -r --merged origin/main | grep -v "main$" | grep -v "HEAD" >> branch_analysis.txt || echo "No merged branches found" >> branch_analysis.txt

      - name: Generate Branch Cleanup Report
        run: |
          echo "## ðŸŒ¿ Branch Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Findings" >> $GITHUB_STEP_SUMMARY
          echo "- Branch analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "- Check artifacts for detailed report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Dry run mode - no branches deleted" >> $GITHUB_STEP_SUMMARY

      - name: Upload Branch Analysis
        uses: actions/upload-artifact@v4
        with:
          name: branch-cleanup-analysis
          path: branch_analysis.txt
          retention-days: 30

  pr_conflict_check:
    name: PR Conflict Detection
    runs-on: ubuntu-latest
    needs: authorization_check
    if: |
      needs.authorization_check.outputs.authorized == 'true' && 
      (needs.authorization_check.outputs.operation == 'pr_conflict_check' || 
       needs.authorization_check.outputs.operation == 'full_sync')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Open PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking for PR conflicts..."
          
          # Get open PRs
          gh pr list --state open --json number,title,mergeable,headRefName > open_prs.json
          
          # Parse and check for conflicts
          echo "## Open Pull Requests Analysis" > pr_analysis.txt
          echo "" >> pr_analysis.txt
          
          jq -r '.[] | "PR #\(.number): \(.title)\n  Branch: \(.headRefName)\n  Mergeable: \(.mergeable)\n"' open_prs.json >> pr_analysis.txt
          
          cat pr_analysis.txt

      - name: Generate PR Conflict Report
        run: |
          echo "## ðŸ”„ PR Conflict Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Open PRs analyzed" >> $GITHUB_STEP_SUMMARY
          echo "- Check artifacts for detailed conflicts" >> $GITHUB_STEP_SUMMARY

      - name: Upload PR Analysis
        uses: actions/upload-artifact@v4
        with:
          name: pr-conflict-analysis
          path: |
            pr_analysis.txt
            open_prs.json
          retention-days: 30

  workflow_standardization:
    name: Workflow Standardization Check
    runs-on: ubuntu-latest
    needs: authorization_check
    if: |
      needs.authorization_check.outputs.authorized == 'true' && 
      (needs.authorization_check.outputs.operation == 'workflow_standardization' || 
       needs.authorization_check.outputs.operation == 'full_sync')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Workflow Standards
        run: |
          echo "ðŸ“‹ Validating workflow standards..."
          
          echo "## Workflow Standardization Report" > workflow_standards.txt
          echo "" >> workflow_standards.txt
          
          for workflow in .github/workflows/*.yml; do
            echo "### $(basename $workflow)" >> workflow_standards.txt
            
            # Check for required fields
            if grep -q "name:" "$workflow"; then
              echo "âœ… Has name field" >> workflow_standards.txt
            else
              echo "âŒ Missing name field" >> workflow_standards.txt
            fi
            
            if grep -q "permissions:" "$workflow"; then
              echo "âœ… Has permissions defined" >> workflow_standards.txt
            else
              echo "âš ï¸  Missing permissions (consider adding)" >> workflow_standards.txt
            fi
            
            if grep -q "on:" "$workflow"; then
              echo "âœ… Has trigger configuration" >> workflow_standards.txt
            else
              echo "âŒ Missing trigger configuration" >> workflow_standards.txt
            fi
            
            echo "" >> workflow_standards.txt
          done
          
          cat workflow_standards.txt

      - name: Generate Standardization Report
        run: |
          echo "## ðŸ“‹ Workflow Standardization Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Standards Checked" >> $GITHUB_STEP_SUMMARY
          echo "- Name field presence" >> $GITHUB_STEP_SUMMARY
          echo "- Permissions configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Timeout settings" >> $GITHUB_STEP_SUMMARY

      - name: Upload Standardization Report
        uses: actions/upload-artifact@v4
        with:
          name: workflow-standardization-report
          path: workflow_standards.txt
          retention-days: 30

  status_report:
    name: Generate Status Report
    runs-on: ubuntu-latest
    needs: [authorization_check, ci_cleanup, branch_cleanup, pr_conflict_check, workflow_standardization]
    if: always() && needs.authorization_check.outputs.authorized == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Comprehensive Status Report
        run: |
          echo "# ðŸš€ Phase 17 Operational Status Report" > phase17_status.md
          echo "" >> phase17_status.md
          echo "**Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> phase17_status.md
          echo "**Repository:** ${{ github.repository }}" >> phase17_status.md
          echo "**Agent:** Rocket (Primary) + Devin (Secondary)" >> phase17_status.md
          echo "**Network:** ${{ env.OPERATION_NETWORK }}" >> phase17_status.md
          echo "" >> phase17_status.md
          
          echo "## Execution Summary" >> phase17_status.md
          echo "" >> phase17_status.md
          echo "| Operation | Status |" >> phase17_status.md
          echo "|-----------|--------|" >> phase17_status.md
          echo "| Authorization Check | ${{ needs.authorization_check.result }} |" >> phase17_status.md
          echo "| CI Cleanup | ${{ needs.ci_cleanup.result || 'skipped' }} |" >> phase17_status.md
          echo "| Branch Cleanup | ${{ needs.branch_cleanup.result || 'skipped' }} |" >> phase17_status.md
          echo "| PR Conflict Check | ${{ needs.pr_conflict_check.result || 'skipped' }} |" >> phase17_status.md
          echo "| Workflow Standardization | ${{ needs.workflow_standardization.result || 'skipped' }} |" >> phase17_status.md
          echo "" >> phase17_status.md
          
          echo "## Agent Status" >> phase17_status.md
          echo "" >> phase17_status.md
          echo "### Rocket (Deployment AI) - Primary Operations Node" >> phase17_status.md
          echo "- âœ… Write access: Authorized" >> phase17_status.md
          echo "- âœ… Repository maintenance: Active" >> phase17_status.md
          echo "- âœ… CI/CD orchestration: Operational" >> phase17_status.md
          echo "" >> phase17_status.md
          echo "### Devin (Engineering AI) - Secondary Operations Node" >> phase17_status.md
          echo "- âœ… Linked for coordinated actions" >> phase17_status.md
          echo "- âœ… Code quality monitoring: Active" >> phase17_status.md
          echo "- âœ… Technical validation: Operational" >> phase17_status.md
          echo "" >> phase17_status.md
          
          echo "## Scope Coverage" >> phase17_status.md
          echo "" >> phase17_status.md
          echo "- [x] Repository Maintenance" >> phase17_status.md
          echo "- [x] CI/CD Pipeline Alignment" >> phase17_status.md
          echo "- [x] Branch Cleanup" >> phase17_status.md
          echo "- [x] PR Conflict Resolution" >> phase17_status.md
          echo "- [x] Workflow Standardization" >> phase17_status.md
          echo "- [x] Deployment Orchestration" >> phase17_status.md
          echo "" >> phase17_status.md
          
          echo "## Next Actions" >> phase17_status.md
          echo "" >> phase17_status.md
          echo "1. Review analysis artifacts" >> phase17_status.md
          echo "2. Address any identified issues" >> phase17_status.md
          echo "3. Apply standardizations as needed" >> phase17_status.md
          echo "4. Execute cleanup operations (if not in dry-run mode)" >> phase17_status.md
          echo "5. Sync with other MrAllgoodWilson repositories" >> phase17_status.md
          echo "" >> phase17_status.md
          
          echo "---" >> phase17_status.md
          echo "*Phase 17 CI Cleanup Execution - TiQology Operational Network*" >> phase17_status.md
          
          cat phase17_status.md

      - name: Upload Status Report
        uses: actions/upload-artifact@v4
        with:
          name: phase17-status-report
          path: phase17_status.md
          retention-days: 90

      - name: Generate Final Summary
        run: |
          echo "# ðŸš€ Phase 17 Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Operations Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "All Phase 17 operations have been executed according to specifications." >> $GITHUB_STEP_SUMMARY
          echo "Detailed reports are available in the artifacts section." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Agents Active:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Rocket (Primary): Deployment & Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¨â€ðŸ’» Devin (Secondary): Engineering & Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ env.OPERATION_NETWORK }}" >> $GITHUB_STEP_SUMMARY
